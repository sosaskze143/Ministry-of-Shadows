<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بوابة وزارة الظلال - خدمات</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #111;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: gold;
      margin-bottom: 30px;
    }
    button {
      margin: 5px;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      background: gold;
      color: black;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) {
      background: #ffc400;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .form-container {
      display: none;
      margin-top: 30px;
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin-inline: auto;
      text-align: right;
    }
    .form-container input, .form-container select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    .form-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #cardDisplay, #dataDisplay {
      margin-top: 20px;
      background: #333;
      padding: 15px;
      border-radius: 10px;
      text-align: right;
      white-space: pre-wrap;
      display: none;
    }
  </style>
</head>
<body>

<h1>بوابة وزارة الظلال - الخدمات</h1>

<div>
  <p>اختر النموذج:</p>
  <button onclick="selectForm('form1')">طلب تجنيس</button>
  <button onclick="selectForm('form2')">طلب إصدار بطاقة إثبات</button>
  <button onclick="selectForm('form3')">طلب تفعيل بطاقة إثبات</button>
  <button onclick="selectForm('form4')">عرض بطاقة إثبات</button>
  <button onclick="selectForm('form5')">طلب بيانات التجنيس</button>
</div>

<div style="margin-top:20px;">
  <button id="showBtn" onclick="showSelectedForm()" disabled>عرض النموذج</button>
</div>

<!-- 1. طلب تجنيس -->
<div id="form1" class="form-container" >
  <h2>طلب تجنيس</h2>
  <label>الاسم كامل</label>
  <input type="text" id="fullName" required />
  <label>تاريخ الميلاد</label>
  <input type="date" id="birthDate" required />
  <label>العنوان الوطني</label>
  <input type="text" id="address" required />
  <label>الجنس</label>
  <select id="gender" required>
    <option value="">اختر الجنس</option>
    <option value="ذكر">ذكر</option>
    <option value="أنثى">أنثى</option>
  </select>
  <label>مكان الميلاد</label>
  <input type="text" id="birthPlace" required />
  <label>رقم الجوال</label>
  <input type="tel" id="phone" required />
  <label>البريد الإلكتروني</label>
  <input type="email" id="email" required />
  <label>فصيلة الدم</label>
  <input type="text" id="bloodType" required />
  <label>الحالة الاجتماعية</label>
  <input type="text" id="maritalStatus" required />
  <button onclick="submitNationality()">طلب تجنيس</button>
</div>

<!-- 2. طلب إصدار بطاقة إثبات -->
<div id="form2" class="form-container">
  <h2>طلب إصدار بطاقة إثبات</h2>
  <label>رقم الهوية</label>
  <input type="text" id="issueID" required />
  <label>رقم الملف</label>
  <input type="text" id="issueFileNumber" required />
  <label>البصمة الإلكترونية</label>
  <input type="text" id="issueFingerprint" required />
  <label>تاريخ الميلاد</label>
  <input type="date" id="issueBirthDate" required />
  <button onclick="submitIssueCard()">طلب إصدار البطاقة</button>
</div>

<!-- 3. طلب تفعيل بطاقة إثبات -->
<div id="form3" class="form-container">
  <h2>طلب تفعيل بطاقة إثبات</h2>
  <label>رقم الهوية</label>
  <input type="text" id="activateID" required />
  <label>رقم الملف</label>
  <input type="text" id="activateFileNumber" required />
  <label>رفع صورة شخصية</label>
  <input type="file" id="activatePhoto" accept="image/*" />
  <button onclick="submitActivateCard()">طلب تفعيل البطاقة</button>
</div>

<!-- 4. طلب عرض بطاقة إثبات -->
<div id="form4" class="form-container">
  <h2>عرض بطاقة إثبات</h2>
  <label>رقم الهوية</label>
  <input type="text" id="viewID" required />
  <label>رقم الملف</label>
  <input type="text" id="viewFileNumber" required />
  <label>البصمة الإلكترونية</label>
  <input type="text" id="viewFingerprint" required />
  <label>تاريخ الميلاد</label>
  <input type="date" id="viewBirthDate" required />
  <button onclick="submitViewCard()">عرض البطاقة</button>
  <div id="cardDisplay"></div>
</div>

<!-- 5. طلب بيانات التجنيس -->
<div id="form5" class="form-container">
  <h2>طلب بيانات التجنيس</h2>
  <label>رقم الهوية</label>
  <input type="text" id="dataID" required />
  <label>تاريخ الميلاد</label>
  <input type="date" id="dataBirthDate" required />
  <label>البصمة الإلكترونية</label>
  <input type="text" id="dataFingerprint" required />
  <label>رقم الملف</label>
  <input type="text" id="dataFileNumber" required />
  <button onclick="submitGetData()">عرض بيانات التجنيس</button>
  <pre id="dataDisplay"></pre>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDUrt0-kNxgSVlBF4VgyBW84E0g4SNTmiI",
    authDomain: "portal-shadow.firebaseapp.com",
    projectId: "portal-shadow",
    storageBucket: "portal-shadow.firebasestorage.app",
    messagingSenderId: "800415093843",
    appId: "1:800415093843:web:b9249f69242f929312a2a6",
    measurementId: "G-KPW8FHT7KT"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  let selectedFormId = null;

  window.selectForm = function(formId) {
    selectedFormId = formId;
    document.getElementById('showBtn').disabled = false;
  }

  window.showSelectedForm = function() {
    if (!selectedFormId) return;
    // Hide all forms
    document.querySelectorAll('.form-container').forEach(f => f.style.display = 'none');
    // Show selected form
    document.getElementById(selectedFormId).style.display = 'block';
  }

  function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for(let i=0; i<length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // 1. طلب تجنيس
  window.submitNationality = async function() {
    const fullName = document.getElementById('fullName').value.trim();
    const birthDate = document.getElementById('birthDate').value;
    const address = document.getElementById('address').value.trim();
    const gender = document.getElementById('gender').value;
    const birthPlace = document.getElementById('birthPlace').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const bloodType = document.getElementById('bloodType').value.trim();
    const maritalStatus = document.getElementById('maritalStatus').value.trim();

    if (!fullName || !birthDate || !address || !gender || !birthPlace || !phone || !email || !bloodType || !maritalStatus) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    // توليد رقم ملف 7 أرقام
    const fileNumber = Math.floor(1000000 + Math.random() * 9000000).toString();

    // توليد رقم هوية 10 أرقام يبدأ بـ 10
    let nationalID = "10" + Math.floor(100000000 + Math.random() * 900000000).toString();

    // التأكد عدم التكرار
    const dbRef = ref(database);
    const snapshot = await get(child(dbRef, `citizens/${nationalID}`));
    if (snapshot.exists()) {
      alert("رقم الهوية مولد متكرر، حاول مرة أخرى.");
      return;
    }

    // توليد بصمة إلكترونية 12 حرف ورقم
    const fingerprint = generateRandomString(12);

    const data = {
      fullName,
      birthDate,
      address,
      gender,
      birthPlace,
      phone,
      email,
      bloodType,
      maritalStatus,
      fileNumber,
      nationalID,
      fingerprint
    };

    try {
      await set(ref(database, 'citizens/' + nationalID), data);
      alert(`تم إرسال طلب التجنيس بنجاح!
رقم الملف: ${fileNumber}
رقم الهوية: ${nationalID}
البصمة الإلكترونية: ${fingerprint}`);
      // ممكن تفعل زر اصدار بطاقة أو تحط أي إجراء إضافي هنا
    } catch (error) {
      console.error(error);
      alert("حدث خطأ أثناء الإرسال، حاول مرة أخرى.");
    }
  }

  // 2. طلب إصدار بطاقة إثبات
  window.submitIssueCard = async function() {
    const id = document.getElementById('issueID').value.trim();
    const fileNum = document.getElementById('issueFileNumber').value.trim();
    const fingerprint = document.getElementById('issueFingerprint').value.trim();
    const birthDate = document.getElementById('issueBirthDate').value;

    if (!id || !fileNum || !fingerprint || !birthDate) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    const dbRef = ref(database);
    const citizenSnap = await get(child(dbRef, `citizens/${id}`));
    if (!citizenSnap.exists()) {
      alert("لا يمكن إصدار البطاقة لأن طلب التجنيس غير موجود.");
      return;
    }

    alert("تمت عملية إصدار البطاقة بنجاح!");
  }

  // 3. طلب تفعيل بطاقة إثبات
  window.submitActivateCard = function() {
    const id = document.getElementById('activateID').value.trim();
    const fileNum = document.getElementById('activateFileNumber').value.trim();
    const photoInput = document.getElementById('activatePhoto');

    if (!id || !fileNum) {
      alert("يرجى تعبئة رقم الهوية ورقم الملف.");
      return;
    }
    if (photoInput.files.length === 0) {
      alert("يرجى رفع صورة شخصية.");
      return;
    }

    alert("تمت عملية تفعيل البطاقة بنجاح!");
  }

  // 4. طلب عرض بطاقة إثبات
  window.submitViewCard = async function() {
    const id = document.getElementById('viewID').value.trim();
    const fileNum = document.getElementById('viewFileNumber').value.trim();
    const fingerprint = document.getElementById('viewFingerprint').value.trim();
    const birthDate = document.getElementById('viewBirthDate').value;

    if (!id || !fileNum || !fingerprint || !birthDate) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    const dbRef = ref(database);
    const citizenSnap = await get(child(dbRef, `citizens/${id}`));

    if (!citizenSnap.exists()) {
      alert("لم يتم العثور على البطاقة.");
      return;
    }

    const data = citizenSnap.val();

    if (
      data.fileNumber !== fileNum ||
      data.fingerprint !== fingerprint ||
      data.birthDate !== birthDate
    ) {
      alert("بيانات التحقق غير صحيحة.");
      return;
    }

    const cardDiv = document.getElementById('cardDisplay');
    cardDiv.style.display = 'block';
    cardDiv.textContent = `
بطاقة إثبات شخصية:
الاسم: ${data.fullName}
تاريخ الميلاد: ${data.birthDate}
رقم الهوية: ${id}
رقم الملف: ${data.fileNumber}
البصمة الإلكترونية: ${data.fingerprint}
الجنس: ${data.gender}
مكان الميلاد: ${data.birthPlace}
البريد الإلكتروني: ${data.email}
رقم الجوال: ${data.phone}
    `;
  }

  // 5. طلب بيانات التجنيس
  window.submitGetData = async function() {
    const id = document.getElementById('dataID').value.trim();
    const birthDate = document.getElementById('dataBirthDate').value;
    const fingerprint = document.getElementById('dataFingerprint').value.trim();
    const fileNum = document.getElementById('dataFileNumber').value.trim();

    if (!id || !birthDate || !fingerprint || !fileNum) {
      alert("يرجى تعبئة جميع الحقول.");
      return;
    }

    const dbRef = ref(database);
    const citizenSnap = await get(child(dbRef, `citizens/${id}`));

    if (!citizenSnap.exists()) {
      alert("لم يتم العثور على البيانات.");
      return;
    }

    const data = citizenSnap.val();

    if (
      data.birthDate !== birthDate ||
      data.fingerprint !== fingerprint ||
      data.fileNumber !== fileNum
    ) {
      alert("بيانات التحقق غير صحيحة.");
      return;
    }

    const display = document.getElementById('dataDisplay');
    display.style.display = 'block';
    display.textContent = JSON.stringify(data, null, 2);
  }
</script>

</body>
</html>
